<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VK Video player</title>
    <script src="https://cdn.jsdelivr.net/gh/zurg3/my-stuff@master/js/lib.min.js"></script>
    <style>
      input[type="button"] {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>VK Video player</h2>
    <form id="form" hidden>
      <p>
        <label for="video_link">Video link</label>
        <input type="url" id="video_link" size="60" autocomplete="off">
      </p>
      <p>
        <input type="button" id="open_video_button" value="Submit" onclick="open_video()">
        <input type="button" id="clear_input_button" value="Clear" onclick="clear_input()">
      </p>
    </form>
    <div id="vk_video" hidden></div>
    <script>
      if (is_mobile()) {
        const url_input = document.getElementById('video_link');
        const width = Math.floor(document.body.offsetWidth * 0.9);

        url_input.removeAttribute('size');
        url_input.style.width = `${width}px`;
      }

      const form = document.getElementById('form');
      const video_link = document.getElementById('video_link');

      form.hidden = false;

      let owner_id = '';
      let video_id = '';

      const vk_video = document.getElementById('vk_video');
      const vk_iframe = document.createElement('iframe');

      function open_video() {
        if (video_link.value && (video_link.value.startsWith('https://vkvideo.ru/video') || video_link.value.startsWith('https://vk.com/video'))) {
          const video_url = new URL(video_link.value);

          owner_id = video_url.pathname.replace('/video', '').split('_')[0];
          video_id = video_url.pathname.replace('/video', '').split('_')[1];

          //console.log(`${owner_id}_${video_id}`);

          if (owner_id && video_id) {
            const video_width = !is_mobile() ? 640 : document.body.offsetWidth;
            const video_height = !is_mobile() ? 360 : Math.floor(video_width / 1.77);

            vk_iframe.width = video_width;
            vk_iframe.height = video_height;
            vk_iframe.src = `https://vk.com/video_ext.php?oid=${owner_id}&id=${video_id}`;
            vk_iframe.frameBorder = 0;
            vk_iframe.allow = 'autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock';
            vk_iframe.allowFullscreen = true;

            vk_video.append(vk_iframe);
            vk_video.hidden = false;
          }
        }
      }

      function remove_video() {
        vk_iframe.src = '';
        vk_iframe.remove();
      }

      function clear_input() {
        video_link.value = '';
        vk_video.hidden = true;
        remove_video();
        owner_id = '';
        video_id = '';
      }
    </script>
  </body>
</html>
