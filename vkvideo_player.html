<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VK Video player</title>
    <script src="https://cdn.jsdelivr.net/gh/zurg3/my-stuff@master/js/lib.min.js"></script>
    <style>
      input[type="button"] {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>VK Video player</h2>
    <div id="input" hidden>
      <h3>VK Video Link</h3>
      <p><input type="url" id="video_link" size="60" autocomplete="off"></p>
      <p>
        <input type="button" id="open_video_button" value="Submit" onclick="open_video()">
        <input type="button" id="clear_input_button" value="Clear" onclick="clear_input()">
      </p>
    </div>
    <div id="output" hidden>
      <p id="links"><a id="video_share_link">Watch on VK Video</a> | <a id="video_embed_link">Embedded player</a></p>
      <div id="vk_video"></div>
    </div>
    <script>
      if (is_mobile()) {
        const url_input = document.getElementById('video_link');
        const width = Math.floor(document.body.offsetWidth * 0.9);

        url_input.removeAttribute('size');
        url_input.style.width = `${width}px`;
      }

      const input_block = document.getElementById('input');
      const video_link = document.getElementById('video_link');
      const output_block = document.getElementById('output');
      const video_share_link = document.getElementById('video_share_link');
      const video_embed_link = document.getElementById('video_embed_link');
      const vk_video = document.getElementById('vk_video');
      const vk_iframe = document.createElement('iframe');

      input_block.hidden = false;

      function open_video() {
        if (!video_link.value || !(video_link.value.startsWith('https://') || video_link.value.startsWith('http://'))) return alert('Invalid URL!');

        const video_url = new URL(video_link.value);
        const valid_hosts = ['vk.com', 'vkvideo.ru', 'm.vk.com', 'm.vkvideo.ru'];
        const match = video_url.pathname.match(/video(-?\d+)_(\d+)/);

        if (!valid_hosts.includes(video_url.host) || !match) return alert('Invalid URL!');

        const owner_id = match[1];
        const video_id = match[2];

        //console.log(`${owner_id}_${video_id}`);

        const video_width = !is_mobile() ? 640 : document.body.offsetWidth;
        const video_height = !is_mobile() ? 360 : Math.floor(video_width / 1.77);

        const embed_url = `https://vk.com/video_ext.php?oid=${owner_id}&id=${video_id}`;

        vk_iframe.width = video_width;
        vk_iframe.height = video_height;
        vk_iframe.src = embed_url;
        vk_iframe.frameBorder = 0;
        vk_iframe.allow = 'autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock';
        vk_iframe.allowFullscreen = true;

        vk_video.append(vk_iframe);

        video_share_link.href = `https://vkvideo.ru/video${owner_id}_${video_id}`;
        video_embed_link.href = embed_url;

        output_block.hidden = false;
      }

      function remove_video() {
        vk_iframe.src = '';
        vk_iframe.remove();
      }

      function clear_input() {
        video_link.value = '';
        output_block.hidden = true;
        remove_video();
      }
    </script>
  </body>
</html>
