#!/bin/bash

# Arch Linux Installer

loadkeys ru
setfont cyr-sun16
timedatectl set-ntp true

# hostname, username and passwords settings
read -p "Hostname: " hostname
read -p "Username: " username
read -p "Set root password: " root_password
read -p "Set user password: " user_password

# Kernel selection
echo "Select Kernel version:"
echo "1 - Latest stable (linux)"
echo "2 - Long-term support (linux-lts)"
echo "3 - Linux Zen (linux-zen)"
read -p "-> " kernel_version
case $kernel_version in
  1)
    kernel_install="linux"
    mkinitcpio_preset="linux"
    ;;
  2)
    kernel_install="linux-lts"
    mkinitcpio_preset="linux-lts"
    ;;
  3)
    kernel_install="linux-zen"
    mkinitcpio_preset="linux-zen"
    ;;
  *)
    kernel_install="linux"
    mkinitcpio_preset="linux"
    ;;
esac

# DE selection
echo "Which DE do you want to install?"
echo "1 - Xfce"
echo "2 - GNOME"
echo "3 - LXDE"
echo "4 - Cinnamon"
echo "5 - MATE"
echo "6 - i3"
echo "7 - LXQt"
echo "8 - KDE Plasma"
echo "9 - Pantheon"
echo "10 - Budgie"
echo "0 - Terminal (Don't install any DE)"
read -p "-> " de_setting

# option to install VirtualBox Guest Utils
read -p "Do you install Arch Linux on virtual machine? [y/n] " vm_setting

# DM
case $de_setting in
  1|3|6|7) dm_install="lxdm";;
  2|4|5|8|9|10) dm_install="gdm";;
esac

# DE
case $de_setting in
  1) de_install="xfce4 xfce4-goodies $dm_install";;
  2) de_install="gnome gnome-tweaks $dm_install";;
  3) de_install="lxde";;
  4) de_install="cinnamon $dm_install";;
  5) de_install="mate mate-extra $dm_install";;
  6) de_install="i3-wm i3status i3blocks i3lock dmenu picom xfce4-terminal vim ranger feh cmus mpv scrot $dm_install lxappearance ttf-font-awesome terminus-font";;
  7) de_install="lxqt $dm_install";;
  8) de_install="plasma $dm_install";;
  9) de_install="pantheon $dm_install";;
  10) de_install="budgie $dm_install";;
esac

# xorg, network, fonts
case $de_setting in
  0)
    if [[ $vm_setting == "y" ]]; then
      gui_install="virtualbox-guest-utils"
    fi
    net_install="networkmanager"
    ;;
  1|2|3|4|5|6|7|8|9|10)
    gui_install="xorg-server xorg-drivers xorg-xinit"
    if [[ $vm_setting == "y" ]]; then
      gui_install+=" virtualbox-guest-utils"
    fi
    net_install="networkmanager network-manager-applet ppp"
    font_install="ttf-dejavu ttf-liberation"
    ;;
  *)
    if [[ $vm_setting == "y" ]]; then
      gui_install="virtualbox-guest-utils"
    fi
    net_install="networkmanager"
    ;;
esac

# option to make disk partitions
read -p "Do you want to make disk partitions? [y/n] " disk_partition
if [[ $disk_partition == "y" ]]; then
  echo "Warning! You need at least 50 GB free space on your disk!"
  read -p "1 - default partition, 2 - custom partition: " disk_partition_type
  if [[ $disk_partition_type == 2 ]]; then
    read -p "Enter the size of /boot (/dev/sda1): " boot_size
    read -p "Enter the size of /root (/dev/sda2): " root_size
    read -p "Enter the size of swap (/dev/sda3): " swap_size
  else
    boot_size="500M"
    root_size="20G"
    swap_size="2G"
  fi

  # partition the disks
  (
    echo o;

    echo n;
    echo p;
    echo 1;
    echo;
    echo "+$boot_size";

    echo n;
    echo p;
    echo 2;
    echo;
    echo "+$root_size";

    echo n;
    echo p;
    echo 3;
    echo;
    echo "+$swap_size";

    echo n;
    echo p;
    echo;
    echo;

    echo a;
    echo 1;

    echo w;
  ) | fdisk /dev/sda

  echo "Your disk partitions"
  fdisk -l
  sleep 10
fi

# format the partitions
mkfs.ext2 /dev/sda1 -L boot
mkfs.ext4 /dev/sda2 -L root
mkswap /dev/sda3 -L swap
mkfs.ext4 /dev/sda4 -L home

# mount the file systems
mount /dev/sda2 /mnt
mkdir /mnt/{boot,home}
mount /dev/sda1 /mnt/boot
swapon /dev/sda3
mount /dev/sda4 /mnt/home

# set the mirror and download the base packages
echo "Server = https://mirror.yandex.ru/archlinux/\$repo/os/\$arch" > /etc/pacman.d/mirrorlist
pacstrap -K /mnt base base-devel $kernel_install linux-firmware nano dhcpcd netctl man-db man-pages

# generate fstab file
genfstab -pU /mnt >> /mnt/etc/fstab

# create the script for arch-chroot
echo "#!/bin/bash

echo \"$hostname\" > /etc/hostname
ln -sf /usr/share/zoneinfo/Europe/Moscow /etc/localtime
hwclock --systohc
echo \"en_US.UTF-8 UTF-8\" > /etc/locale.gen
echo \"ru_RU.UTF-8 UTF-8\" >> /etc/locale.gen
locale-gen
echo \"LANG=ru_RU.UTF-8\" > /etc/locale.conf
echo \"KEYMAP=ru\" > /etc/vconsole.conf
echo \"FONT=cyr-sun16\" >> /etc/vconsole.conf
mkinitcpio -p $mkinitcpio_preset
(
  echo \"$root_password\";
  echo \"$root_password\";
) | passwd
useradd -m -g users -G wheel -s /bin/bash $username
(
  echo \"$user_password\";
  echo \"$user_password\";
) | passwd $username
echo -e \"\n%wheel ALL=(ALL) ALL\" >> /etc/sudoers
echo -e \"\n[multilib]\nInclude = /etc/pacman.d/mirrorlist\" >> /etc/pacman.conf
pacman -Syy
pacman -S grub $gui_install $de_install $font_install $net_install
grub-install /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg
systemctl enable $dm_install NetworkManager" > /tmp/ali.sh

chmod +x /mnt/tmp/ali.sh

(
  echo "/tmp/ali.sh";
  echo "exit";
) | arch-chroot /mnt

umount -R /mnt
reboot
